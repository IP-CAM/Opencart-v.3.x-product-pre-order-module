<?xml version="1.0" encoding="utf-8"?>
	<modification>
	<name>Ultrastore - Preorder and Stock status</name>
	<code>oct_preorder_and_stock_status</code>
	<version>1.0.0</version>
	<author>eapdob</author>
	<link>eapdob@gmail.com</link>
	<file path="catalog/controller/common/header.php">
		<operation>
		  <search><![CDATA[public function index() {]]></search>
		  <add position="after"><![CDATA[
				$data['oct_product_preorder_data'] = $this->config->get('oct_product_preorder_data');
		  ]]></add>
		</operation>
  	</file>
	<file path="catalog/language/en-gb/product/product.php">
		<operation>
			<search><![CDATA[<?php]]></search>
			<add position="after"><![CDATA[
				$_['text_instock']      = 'In stock';
				$_['text_outstock']     = '<font style="color: #f56b6b;">Out of stock</font>';
				$_['text_minstock']     = '<font style="color: #f56b6b;">The item ends</font>';
			]]></add>
		</operation> 
	</file>
	<file path="catalog/language/ru-ru/product/product.php">
		<operation>
			<search><![CDATA[<?php]]></search>
			<add position="after"><![CDATA[
				$_['text_instock']      = 'В наличии';
				$_['text_outstock']     = '<font style="color: #f56b6b;">Нет в наличии</font>';
				$_['text_minstock']     = '<font style="color: #f56b6b;">Заканчивается</font>';				
			]]></add>
		</operation> 
	</file>
	<file path="catalog/language/ua-uk/product/product.php">
		<operation>
			<search><![CDATA[<?php]]></search>
			<add position="after"><![CDATA[
				$_['text_instock']      = 'В наявності';
				$_['text_outstock']     = '<font style="color: #f56b6b;">Немає в наявності</font>';
				$_['text_minstock']     = '<font style="color: #f56b6b;">Закінчується</font>';				
			]]></add>
		</operation>
	</file>
	<file path="catalog/language/en-gb/product/{category,search,special,manufacturer}.php">
		<operation>
			<search><![CDATA[<?php]]></search>
			<add position="after"><![CDATA[
				$_['text_stock']        = 'Stock:';
				$_['text_instock']      = 'In stock';
				$_['text_outstock']     = 'Out of stock';
				$_['text_minstock']     = 'The item ends';				
			]]></add>
		</operation> 
	</file>
	<file path="catalog/language/ru-ru/product/{category,search,special,manufacturer}.php">
		<operation>
			<search><![CDATA[<?php]]></search>
			<add position="after"><![CDATA[
				$_['text_stock']        = 'Наличие:';
				$_['text_instock']      = 'На складе';
				$_['text_outstock']     = 'Нет в наличии';
				$_['text_minstock']     = 'Заканчивается';				
			]]></add>
		</operation> 
	</file>
	<file path="catalog/language/ua-uk/product/{category,search,special,manufacturer}.php">
		<operation>
			<search><![CDATA[<?php]]></search>
			<add position="after"><![CDATA[
				$_['text_stock']        = 'Наявність:';
				$_['text_instock']      = 'В наявності';
				$_['text_outstock']     = 'Немає в наявності';
				$_['text_minstock']     = 'Закінчується';				
			]]></add>
		</operation>
	</file>
	<file path="catalog/language/en-gb/octemplates/module/oct_popup_view.php">
		<operation>
			<search><![CDATA[<?php]]></search>
			<add position="after"><![CDATA[
				$_['text_stock']        = 'Stock:';
				$_['text_instock']      = 'In stock';
				$_['text_outstock']     = 'Out of stock';
				$_['text_minstock']     = 'The item ends';
			]]></add>
		</operation>
	</file>
	<file path="catalog/language/ru-ru/octemplates/module/oct_popup_view.php">
		<operation>
			<search><![CDATA[<?php]]></search>
			<add position="after"><![CDATA[
				$_['text_stock']        = 'Наличие:';
				$_['text_instock']      = 'На складе';
				$_['text_outstock']     = 'Нет в наличии';
				$_['text_minstock']     = 'Заканчивается';
			]]></add>
		</operation>
	</file>
	<file path="catalog/language/ua-uk/octemplates/module/oct_popup_view.php">
		<operation>
			<search><![CDATA[<?php]]></search>
			<add position="after"><![CDATA[
				$_['text_stock']        = 'Наявність:';
				$_['text_instock']      = 'В наявності';
				$_['text_outstock']     = 'Немає в наявності';
				$_['text_minstock']     = 'Закінчується';
			]]></add>
		</operation>
	</file>
	<file path="catalog/model/catalog/product.php">
		<operation>
			<search><![CDATA['viewed'           => $query->row['viewed']]]></search>
			<add position="before"><![CDATA[
				'oct_stock_status_id' => $query->row['stock_status_id'],
			]]></add>
		</operation>
	</file>
	<file path="catalog/controller/product/product.php">
		<operation>
			<search><![CDATA[if ($product_info['quantity'] <= 0) {]]></search>
			<add position="replace" offset="6"><![CDATA[
				$data['disable_buy'] = 0;
				
				$oct_product_preorder_text = $this->config->get('oct_product_preorder_text');
				$oct_product_preorder_data = $this->config->get('oct_product_preorder_data');
				$oct_product_stock_checkout = $this->config->get('config_stock_checkout');

				if (isset($oct_product_preorder_data['status']) && $oct_product_preorder_data['status'] && isset($oct_product_preorder_data['stock_statuses']) && isset($product_info['oct_stock_status_id']) && in_array($product_info['oct_stock_status_id'], $oct_product_preorder_data['stock_statuses'])) {
					if ($product_info['quantity'] <= 0) {
						$data['stock'] = $product_info['stock_status'];
						$data['stockbutton'] = $oct_product_preorder_text[$this->session->data['language']]['call_button'];
						if ($oct_product_stock_checkout == 0) {
							$data['disable_buy'] = 1;
						}
					} elseif ($this->config->get('config_stock_display')) {
						$data['stock'] = $product_info['quantity'];
					} elseif ($product_info['quantity'] >= 1 && $product_info['quantity'] <= 3) {
						$data['stock'] = $this->language->get('text_minstock');
					} else {
						$data['stock'] = $this->language->get('text_instock');
					}
				} else {
					if ($product_info['quantity'] <= 0) {
						$data['stock'] = $product_info['stock_status'];
						$data['stockbutton'] = $product_info['stock_status'];
						if ($oct_product_stock_checkout == 0) {
							$data['disable_buy'] = 2;
						}
					} elseif ($this->config->get('config_stock_display')) {
						$data['stock'] = $product_info['quantity'];
						$data['stockbutton'] = $product_info['quantity'];
					} else {
						$data['stock'] = $this->language->get('text_instock');
						$data['stockbutton'] = $this->language->get('text_instock');
					}
				}
			]]></add>
		</operation>
		<operation>
			<search><![CDATA[$data['products'][] = array(]]></search>
			<add position="before"><![CDATA[
				$oct_product_preorder_text = $this->config->get('oct_product_preorder_text');
				$oct_product_preorder_data = $this->config->get('oct_product_preorder_data');
				$oct_product_preorder_language = $this->load->language('octemplates/module/oct_product_preorder');

				if (isset($oct_product_preorder_data['status']) && $oct_product_preorder_data['status'] && isset($oct_product_preorder_data['stock_statuses']) && isset($result['oct_stock_status_id']) && in_array($result['oct_stock_status_id'], $oct_product_preorder_data['stock_statuses'])) {
					$product_preorder_text = $oct_product_preorder_text[$this->session->data['language']]['call_button'];
					$product_preorder_status = 1;
				} else {
					$product_preorder_text = $oct_product_preorder_language['text_out_of_stock'];
					$product_preorder_status = 2;
				}
			 ]]></add>
		</operation>
		<operation>
			<search><![CDATA[$data['products'][] = array(]]></search>
			<add position="after"><![CDATA[
				'quantity' => $result['quantity'],
				'product_preorder_text' => $product_preorder_text,
				'product_preorder_status' => $product_preorder_status,
			]]></add>
		</operation>
	</file>	
	<file path="catalog/controller/product/{category,search,special,manufacturer}.php">
		<operation>
			<search><![CDATA[$data['products'][] = array(]]></search>
			<add position="before"><![CDATA[
				$oct_product_preorder_text = $this->config->get('oct_product_preorder_text');
				$oct_product_preorder_data = $this->config->get('oct_product_preorder_data');
				$oct_product_preorder_language = $this->load->language('octemplates/module/oct_product_preorder');
				$data['text_stock'] = $this->language->get('text_stock');

				if (isset($oct_product_preorder_data['status']) && $oct_product_preorder_data['status'] && isset($oct_product_preorder_data['stock_statuses']) && isset($result['oct_stock_status_id']) && in_array($result['oct_stock_status_id'], $oct_product_preorder_data['stock_statuses'])) {
					$product_preorder_text = $oct_product_preorder_text[$this->session->data['language']]['call_button'];
					$product_preorder_status = 1;
				} else {
					$product_preorder_text = $oct_product_preorder_language['text_out_of_stock'];
					$product_preorder_status = 2;
				}
			]]></add>
		</operation>
		<operation>
			<search><![CDATA['price'       => $price,]]></search>
			<add position="before"><![CDATA[
				'quantity'       => $result['quantity'], 
				'product_preorder_text' => $product_preorder_text,
				'product_preorder_status' => $product_preorder_status,
			]]></add>
		</operation>
	</file>	
	<file path="catalog/controller/extension/module/{bestseller,latest,special}.php">
		<operation>
			<search><![CDATA[$data['products'][] = array(]]></search>
			<add position="before"><![CDATA[
				$oct_product_preorder_text = $this->config->get('oct_product_preorder_text');
				$oct_product_preorder_data = $this->config->get('oct_product_preorder_data');
				$oct_product_preorder_language = $this->load->language('octemplates/module/oct_product_preorder');

				if (isset($oct_product_preorder_data['status']) && $oct_product_preorder_data['status'] && isset($oct_product_preorder_data['stock_statuses']) && isset($result['oct_stock_status_id']) && in_array($result['oct_stock_status_id'], $oct_product_preorder_data['stock_statuses'])) {
					$product_preorder_text = $oct_product_preorder_text[$this->session->data['language']]['call_button'];
					$product_preorder_status = 1;
				} else {
					$product_preorder_text = $oct_product_preorder_language['text_out_of_stock'];
					$product_preorder_status = 2;
				}
			]]></add>
		</operation>
		<operation>
			<search><![CDATA['price'       => $price,]]></search>
			<add position="before"><![CDATA[
				'quantity'       => $result['quantity'], 
				'product_preorder_text' => $product_preorder_text,
				'product_preorder_status' => $product_preorder_status,
			]]></add>
		</operation>
	</file>	
	<file path="catalog/controller/extension/module/featured.php">
		<operation>
			<search><![CDATA[$data['products'][] = array(]]></search>
			<add position="before"><![CDATA[
				$oct_product_preorder_text = $this->config->get('oct_product_preorder_text');
				$oct_product_preorder_data = $this->config->get('oct_product_preorder_data');
				$oct_product_preorder_language = $this->load->language('octemplates/module/oct_product_preorder');

				if (isset($oct_product_preorder_data['status']) && $oct_product_preorder_data['status'] && isset($oct_product_preorder_data['stock_statuses']) && isset($product_info['oct_stock_status_id']) && in_array($product_info['oct_stock_status_id'], $oct_product_preorder_data['stock_statuses'])) {
					$product_preorder_text = $oct_product_preorder_text[$this->session->data['language']]['call_button'];
					$product_preorder_status = 1;
				} else {
					$product_preorder_text = $oct_product_preorder_language['text_out_of_stock'];
					$product_preorder_status = 2;
				}
			]]></add>
		</operation>
		<operation>
			<search><![CDATA['price'       => $price,]]></search>
			<add position="before"><![CDATA[
				'quantity'       => $product_info['quantity'], 
				'product_preorder_text' => $product_preorder_text,
				'product_preorder_status' => $product_preorder_status,
			]]></add>
		</operation>
	</file>
<!--	<file path="catalog/controller/octemplates/module/oct_popup_view.php">-->
<!--		<operation>-->
<!--			<search><![CDATA[$discounts = $this->model_catalog_product->getProductDiscounts($product_id);]]></search>-->
<!--			<add position="before"><![CDATA[-->
<!--				$oct_product_preorder_text = $this->config->get('oct_product_preorder_text');-->
<!--				$oct_product_preorder_data = $this->config->get('oct_product_preorder_data');-->
<!--				$oct_product_preorder_language = $this->load->language('octemplates/module/oct_product_preorder');-->

<!--				if (isset($oct_product_preorder_data['status']) && $oct_product_preorder_data['status'] && isset($oct_product_preorder_data['stock_statuses']) && isset($product_info['oct_stock_status_id']) && in_array($product_info['oct_stock_status_id'], $oct_product_preorder_data['stock_statuses'])) {-->
<!--					$product_preorder_text = $oct_product_preorder_text[$this->session->data['language']]['call_button'];-->
<!--					$product_preorder_status = 1;-->
<!--				} else {-->
<!--					$product_preorder_text = $oct_product_preorder_language['text_out_of_stock'];-->
<!--					$product_preorder_status = 2;-->
<!--				}-->
<!--			]]></add>-->
<!--		</operation>-->
<!--		<operation>-->
<!--			<search><![CDATA[$discounts = $this->model_catalog_product->getProductDiscounts($product_id);]]></search>-->
<!--			<add position="before"><![CDATA[-->
<!--				$data['quantity']                => $product_info['quantity'],-->
<!--				$data['product_preorder_text']   => $product_preorder_text,-->
<!--				$data['product_preorder_status'] => $product_preorder_status,-->
<!--			]]></add>-->
<!--		</operation>-->
<!--	</file>-->
	<file path="catalog/controller/account/wishlist.php">
		<operation>
			<search><![CDATA[$data['products'][] = array(]]></search>
			<add position="before"><![CDATA[
				$oct_product_preorder_text = $this->config->get('oct_product_preorder_text');
				$oct_product_preorder_data = $this->config->get('oct_product_preorder_data');
				$oct_product_preorder_language = $this->load->language('octemplates/module/oct_product_preorder');

				if (isset($oct_product_preorder_data['status']) && $oct_product_preorder_data['status'] && isset($oct_product_preorder_data['stock_statuses']) && isset($product_info['oct_stock_status_id']) && in_array($product_info['oct_stock_status_id'], $oct_product_preorder_data['stock_statuses'])) {
					$product_preorder_text = $oct_product_preorder_text[$this->session->data['language']]['call_button'];
					$product_preorder_status = 1;
				} else {
					$product_preorder_text = $oct_product_preorder_language['text_out_of_stock'];
					$product_preorder_status = 2;
				}
			]]></add>
		</operation>
		<operation>
			<search><![CDATA[$data['products'][] = array(]]></search>
			<add position="after"><![CDATA[
				'quantity'       => $product_info['quantity'], 
				'product_preorder_text' => $product_preorder_text,
				'product_preorder_status' => $product_preorder_status,
			]]></add>
		</operation>
	</file>		
	<file path="catalog/controller/product/compare.php">
		<operation>
			<search><![CDATA[$data['products'][$product_id] = array(]]></search>
			<add position="before"><![CDATA[
				$oct_product_preorder_text = $this->config->get('oct_product_preorder_text');
				$oct_product_preorder_data = $this->config->get('oct_product_preorder_data');
				$oct_product_preorder_language = $this->load->language('octemplates/module/oct_product_preorder');

				if (isset($oct_product_preorder_data['status']) && $oct_product_preorder_data['status'] && isset($oct_product_preorder_data['stock_statuses']) && isset($product_info['oct_stock_status_id']) && in_array($product_info['oct_stock_status_id'], $oct_product_preorder_data['stock_statuses'])) {
					$product_preorder_text = $oct_product_preorder_text[$this->session->data['language']]['call_button'];
					$product_preorder_status = 1;
				} else {
					$product_preorder_text = $oct_product_preorder_language['text_out_of_stock'];
					$product_preorder_status = 2;
				}
			]]></add>
		</operation>
		<operation>
			<search><![CDATA[$data['products'][$product_id] = array(]]></search>
			<add position="after"><![CDATA[
				'quantity'       => $product_info['quantity'], 
				'product_preorder_text' => $product_preorder_text,
				'product_preorder_status' => $product_preorder_status,
			]]></add>
		</operation>
	</file>

	<file path="catalog/view/theme/oct_ultrastore/template/product/product.twig">
		<operation>
			<search><![CDATA[<div class="us-product-action-left">]]></search>
			<add position="before"><![CDATA[
				{% if (disable_buy == 0 or disable_buy == 1 or disable_buy == 2) %}
			]]></add>
		</operation>
		<operation>
			<search><![CDATA[{% if (oct_ultrastore_data.product_advantage is defined and oct_ultrastore_data.product_advantage == 'on') and (oct_product_advantages is defined and oct_product_advantages is not empty) %}]]></search>
			<add position="before"><![CDATA[
				{% endif %}
			]]></add>
		</operation>
		<operation>
			<search><![CDATA[<button type="button" id="button-cart" data-loading-text="{{ text_loading }}" class="us-product-btn us-product-btn-active">{{ button_cart }}</button>]]></search>
			<add position="replace"><![CDATA[
				{% if disable_buy == 0 %}
				<button type="button" id="button-cart" data-loading-text="{{ text_loading }}" class="us-product-btn us-product-btn-active">{{ button_cart }}</button>
				{% elseif disable_buy == 1 %}
				<button type="button" id="preorder-cart" data-loading-text="{{ text_loading }}" onclick="get_oct_product_preorder('{{ product_id }}')" class="us-product-btn us-product-btn-preorder us-product-btn-active">{{ stockbutton }}</button>
				{% else %}
				<button type="button" id="button-cart" data-loading-text="{{ text_loading }}" onclick="javascript:void(0)" class="us-product-btn us-product-btn-in-active">{{ stock_button }}</button>
				{% endif %}
			]]></add>
		</operation>
		<operation>
			<search><![CDATA[{{ footer }}]]></search>
			<add position="before">
				$(function() {
					function get_oct_product_preorder(product_id) {
						masked('body', true);
						$(".modal-backdrop").remove();
						$.ajax({
							type: 'post',
							dataType: 'html',
							url: 'index.php?route=octemplates/module/oct_product_preorder',
							data: 'product_id=' + product_id,
							success: function(data) {
								masked('body', false);
								$(".modal-holder").html(data);
								$("#us-oct-product-preorder-modal").modal("show");
							}
						});
					}
				});
			</add>
		</operation>
	</file>
</modification>